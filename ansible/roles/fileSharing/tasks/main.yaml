---

- name: Setup Docker if not present/running
  block:
  - name: Check if Docker is running
    command: systemctl status docker
    changed_when: false

  rescue:
  - name: Setup calling with a default user
    vars:
      docker_user: "{{ docker_user }}"
      groupname: "{{ groupname }}"
    import_tasks: roles/common/tasks/setup-user-group.yaml

  - name: Setup Docker in calling container
    import_tasks: roles/common/tasks/setup-docker-support.yaml

  always:
  - name: Copy docker-compose.yaml
    template:
      src: docker-compose.yaml.j2
      dest: "{{ docker_compose_dir }}/docker-compose.yaml"
      owner: "{{ docker_user }}"
      group: "{{ groupname }}"
      mode: 0644

  - name: Deploy docker applications
    become: true
    become_user: "{{ docker_user }}"
    become_method: su
    community.docker.docker_compose:
      project_src: "{{ docker_compose_dir }}"
      state: present

  # TODO: Add step to create needed buckets, e.g. by using
  # https://github.com/alexisfacques/ansible-module-s3-minio-bucket
